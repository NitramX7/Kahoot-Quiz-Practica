<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>En Juego | QuizMaster Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/css/quizmaster.css?v=2">
    <style>
        .timer-bar {
            height: 10px;
            background: #E2E8F0;
            border-radius: 5px;
            overflow: hidden;
            margin: 20px 0;
        }

        .timer-fill {
            height: 100%;
            background: #2563EB;
            width: 100%;
            transition: width 1s linear;
        }

        .question-card {
            background: white;
            padding: 40px;
            border-radius: 24px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
            margin-bottom: 30px;
        }

        .monitor-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 40px;
        }

        .monitor-stat {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 16px;
            text-align: center;
        }
    </style>
</head>

<body>
    <div class="app-layout">
        <div th:replace="~{fragments/sidebar :: sidebar('')}"></div>

        <main class="main-content" style="max-width: 1200px; margin: 0 auto;">
            <div class="d-flex justify-between align-center mb-4" th:if="${currentQuestion != null}">
                <div class="badge badge-primary">Pregunta <span th:text="${currentQuestion.orderNum}">1</span></div>
                <div style="font-size: 24px; font-weight: 800; color: #2563EB;" id="timerDisplay">
                    <i class="fas fa-clock"></i> <span th:text="${room.timePerQuestion}">20</span>s
                </div>
            </div>

            <div class="timer-bar" th:if="${currentQuestion != null}">
                <div class="timer-fill" id="timerFill"></div>
            </div>

            <div class="question-card" th:if="${currentQuestion != null}">
                <h1 style="font-size: 36px; color: #1E293B; margin-bottom: 30px;"
                    th:text="${currentQuestion.question.text}">
                    ¿Pregunta de ejemplo?
                </h1>

                <div class="monitor-grid">
                    <div class="monitor-stat">
                        <div style="font-size: 40px; font-weight: 800; color: #10B981;" id="answersCount">0</div>
                        <div style="color: #64748B;">Respuestas</div>
                    </div>
                    <div class="monitor-stat">
                        <div style="font-size: 40px; font-weight: 800; color: #6366F1;"
                            th:text="${#lists.size(room.players)}">0</div>
                        <div style="color: #64748B;">Jugadores</div>
                    </div>
                </div>
            </div>

            <div class="question-card" th:if="${currentQuestion == null}">
                <h2 style="font-size: 28px; color: #1E293B; margin-bottom: 10px;">
                    Esperando a que se abra la pregunta...
                </h2>
                <p style="color: #64748B;">En unos segundos debería mostrarse automáticamente.</p>
            </div>

            <div class="text-center">
                <button id="nextBtn" class="btn btn-primary" onclick="nextQuestion()"
                    style="display: none; font-size: 20px; padding: 15px 40px;">
                    Siguiente Pregunta <i class="fas fa-arrow-right ml-2"></i>
                </button>
            </div>
        </main>
    </div>

    <script th:inline="javascript">
        const roomId = [[${ room.id }]];
        const timeLimit = [[${ room.timePerQuestion }]];
        let timeLeft = timeLimit;
        let currentQuestionId = /*[[${currentQuestion != null ? currentQuestion.id : null}]]*/ null;

        // Timer Logic (only when elements exist)
        const timerFill = document.getElementById('timerFill');
        const timerDisplay = document.querySelector('#timerDisplay span');
        const nextBtn = document.getElementById('nextBtn');

        if (timerFill && timerDisplay && nextBtn) {
            const timer = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = timeLeft;
                timerFill.style.width = (timeLeft / timeLimit * 100) + '%';

                if (timeLeft <= 0) {
                    clearInterval(timer);
                    nextBtn.style.display = 'inline-flex';
                }
            }, 1000);
        }

        function nextQuestion() {
            fetch(`/api/rooms/${roomId}/next-question`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': document.querySelector('input[name="_csrf"]')?.value // Attempt to get CSRF if present in DOM, else might need meta tag
                }
            })
                .then(res => res.json())
                .then(data => {
                    if (data.finished) {
                        window.location.href = `/rooms/${roomId}/podium`;
                    } else {
                        window.location.reload();
                    }
                });
        }

        // Poll for updates (answers count / next question / finish)
        setInterval(() => {
            fetch(`/api/rooms/${roomId}/current-question`)
                .then(res => res.json())
                .then(data => {
                    if (data.finished) {
                        window.location.href = `/rooms/${roomId}/podium`;
                        return;
                    }
                    if (data.id && data.id !== currentQuestionId) {
                        window.location.reload();
                        return;
                    }
                    if (!currentQuestionId && data.id) {
                        window.location.reload();
                        return;
                    }
                    if (typeof data.answersCount === 'number') {
                        const answersCountEl = document.getElementById('answersCount');
                        if (answersCountEl) {
                            answersCountEl.textContent = data.answersCount;
                        }
                    }
                });
        }, 1000);

        // Need CSRF token for POST
        // In this simple version we might need to add it to meta tags or hidden input
    </script>
    <!--Añadir token CSRF para JS-->
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
    <script>
        // Fix CSRF lookup
        const csrfToken = document.querySelector('input[name="_csrf"]').value;
        const originalFetch = window.fetch;
        window.fetch = function () {
            let args = Array.from(arguments);
            if (args[1] && args[1].method === 'POST') {
                args[1].headers = {
                    ...args[1].headers,
                    'X-CSRF-TOKEN': csrfToken
                };
            }
            return originalFetch.apply(this, args);
        };
    </script>
</body>

</html>
